/// <summary>
/// User entity representing authenticated users. Created automatically
/// on first OIDC login. The first user to log in is promoted to admin.
/// </summary>
unit UserEntityU;

interface

uses
  MVCFramework.ActiveRecord,
  MVCFramework.Nullables,
  MVCFramework.Serializer.Commons;

type
  /// <summary>
  /// ActiveRecord entity mapped to the users table. Stores OIDC subject,
  /// email, display name, role, and login timestamps.
  /// </summary>
  [MVCNameCase(ncLowerCase)]
  [MVCTable('users')]
  TUser = class(TMVCActiveRecord)
  private
    [MVCTableField('id', [foPrimaryKey, foAutoGenerated])]
    FId: NullableInt64;

    [MVCTableField('oidc_subject')]
    FOidcSubject: string;

    [MVCTableField('email')]
    FEmail: NullableString;

    [MVCTableField('display_name')]
    FDisplayName: NullableString;

    [MVCTableField('role')]
    FRole: string;

    [MVCTableField('last_login_at')]
    FLastLoginAt: NullableTDateTime;

    [MVCTableField('created_at', [foAutoGenerated])]
    FCreatedAt: NullableTDateTime;
  protected
    /// <summary>
    /// Validate required fields before insert or update.
    /// </summary>
    procedure OnValidation(const Action: TMVCEntityAction); override;
  public
    property Id: NullableInt64 read FId write FId;
    property OidcSubject: string read FOidcSubject write FOidcSubject;
    property Email: NullableString read FEmail write FEmail;
    property DisplayName: NullableString read FDisplayName write FDisplayName;
    property Role: string read FRole write FRole;
    property LastLoginAt: NullableTDateTime read FLastLoginAt write FLastLoginAt;
    property CreatedAt: NullableTDateTime read FCreatedAt;
  end;

implementation

uses
  System.SysUtils;

resourcestring
  SErrOidcSubjectRequired = 'OIDC subject is required';
  SErrRoleRequired = 'User role is required';

procedure TUser.OnValidation(const Action: TMVCEntityAction);
begin
  inherited;
  if FOidcSubject.Trim.IsEmpty then
    raise EMVCActiveRecord.Create(SErrOidcSubjectRequired);
  if FRole.Trim.IsEmpty then
    raise EMVCActiveRecord.Create(SErrRoleRequired);
end;

initialization
  ActiveRecordMappingRegistry.AddEntity('users', TUser);

end.
